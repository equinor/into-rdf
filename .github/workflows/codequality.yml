name: 'ğŸ’ Code Quality'
on:
  workflow_dispatch:
  workflow_call:
        secrets:
            SNYK_TOKEN:
                required: true
            AZURE_CLIENT_ID:
                required: true
            AZURE_TENANT_ID:
                required: true
  schedule:
  # Run every monday at 0200UTC
    - cron: "0 2 * * 1"
    
env:
  DOTNET_VERSION: '6.x.x'

jobs:
  code_quality:
    name: 'ğŸ› ï¸ Build & ğŸ§ª Test'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v3.0.0
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore -r linux-x64
        
      - name: ğŸ› ï¸ Build Solution
        run: dotnet build --no-restore --configuration Release
      
      - name: ğŸ§ª Run Tests
        run: dotnet test --no-restore --no-build --configuration Release
        
  security_vulnerabilities:
    name: ğŸš¨ Security vulnerabilities
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v3.0.0
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore -r linux-x64

      - uses: snyk/actions/setup@master
      - name: Run Snyk to check for vulnerabilities
        run: snyk test --fail-on=all --severity-threshold=high --file=SpineSplinter.sln
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
