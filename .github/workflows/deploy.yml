name: "ðŸš€ Deploy"
on:
  workflow_call:
    inputs:
      artifact:
        required: true
        type: string
      env:
        required: true
        type: string
      buildid:
        required: true
        type: string
      sku:
        required: true
        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      API_CLIENT_ID:
        required: true
      FUNC_PUBLISH_PROFILE:
        required: true

concurrency: ${{ inputs.env }}

jobs:
  Deploy:
    environment: ${{ inputs.env }}
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.artifact }}

      - name: Azure Login
        uses: Azure/login@v1.4.6
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Setup Azure Resources
        working-directory: azure
        run: |
          chmod +x runMainBicep.sh
          ./runMainBicep.sh -e  ${{ inputs.env }} -b ${{ inputs.buildid }}

      - name: Replace Env-specific settings
        uses: microsoft/variable-substitution@v1
        with:
          files: "**/appsettings.json, **/settings.json"
        env:
          AzureAd.ClientId: ${{ secrets.API_CLIENT_ID }}
          KeyVaultName: "${{ inputs.env }}-splinter-vault"
          ServiceBus.Topic: ${{ secrets.SERVICE_BUS_TOPIC }}
          ENV: ${{ inputs.env }}

      - name: Deploy API
        uses: Azure/webapps-deploy@v2.2.3
        with:
          app-name: "${{ inputs.env }}-splinter-api"
          package: api/
